---
title: Openvpn on Raspberry Pi
date: 2013-06-17 08:12:52
tags:
    
    - Linux
    
    
    - Security
    
     
categories:
    
    - Linux
    
    
    - Security
    
     
keywords: 
    
    - Linux
    
    
    - Security
    
     
---
<p>So sommar is comming and I planning to be away as mutch as possible.<br />
But I need an door in to my server at home for some work. When Im of i only will have an 3g/4g connections so its mutch nicer to work against my server home at a stabel 100 line.</p>
<p>So for making this possibel I install en openvpn server on my PI sitting in my closet.<br />
THIS CONFIG SEND ALL TRAFFIC TROW THE VPN so be ware ðŸ™‚</p>
<p>Installing Openvpn</p>
<pre><em>apt-get install openvpn openssl</em></pre>
<p>Setting up keys used for vpn</p>
<pre>cd /etc/openvpn
cp -r /usr/share/doc/openvpn/examples/easy-rsa/2.0 ./easy-rs
cd easy-rsa/</pre>
<p>Open the file vars and at the buttom enter your settings</p>
<pre>export KEY_COUNTRY="SE"
export KEY_PROVINCE="ST"
export KEY_CITY="Stockholm"
export KEY_ORG="Elino"
export KEY_EMAIL="matte@elino.se"
export KEY_EMAIL=matte@elino.se
export KEY_CN=elino.no-ip.org
export KEY_NAME=mepi
export KEY_OU=mepi
export PKCS11_MODULE_PATH=changeme
export PKCS11_PIN=1234</pre>
<p>make new synlink to config file</p>
<pre>ln -s openssl-1.0.0.cnf openssl.cnf</pre>
<p>Ok ready to make som certs first load and clean all certs (Onlye clean the first time you will delete all certs)</p>
<pre>source vars
./clean-all</pre>
<pre>./build-ca openvpn
<em>./build-key-server server
</em><em>./build-dh
</em>openvpn --genkey --secret ta.key</pre>
<p>Installing the certs</p>
<pre>cp keyscp server.crt server.key ca.crt ../ta.key dh1024.pem /etc/openvpn/</pre>
<p>Set up the openvpn config</p>
<p>make the file /etc/openvpn/server.conf and past the following into the file</p>
<pre>dev tun
proto udp
port 1194
ca /etc/openvpn/ca.crt
cert /etc/openvpn/server.crt
key /etc/openvpn/server.key
dh /etc/openvpn/dh1024.pem
user nobody
tls-auth ta.key 0
group nogroup
server 10.8.0.0 255.255.255.0
persist-key
persist-tun
status /var/log/openvpn-status.log
verb 3
client-to-client
push "redirect-gateway def1"
#set the dns servers
push "dhcp-option DNS 8.8.8.8"
push "dhcp-option DNS 8.8.4.4"
log-append /var/log/openvpn
comp-lzo</pre>
<p>Restart the vpn server</p>
<pre>/etc/init./openvpn restart</pre>
<p>look in the logfile (/var/log/openvpn) to se that the server started and do a ifconfig to make shoure you have a tun device.</p>
<p>Now we must enabled traffic forwarding.</p>
<pre>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</pre>
<pre>iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j SNAT --to [ipadres rpi]</pre>
<pre></pre>
<p>Make shoure this command is run if you restart your pi.</p>
<h2>Making some clients to the server</h2>
<p>First lets make som certs to use.</p>
<pre>cd /etc/openvpn/easy-rsa/
 source vars
 ./build-key mahe</pre>
<p>Copy the certs needed</p>
<pre>mkdir /etc/openvpn/clients
mkdir /etc/openvpn/clients/mahe
cd keys
cp mahe.crt mahe.key ca.crt ../ta.key /etc/openvpn/clients/mahe/</pre>
<p>make an client config file nane /etc/openvpn/cleints/mahe/client.con (if used on windows call the file client.ovpn)</p>
<pre>dev tun
client
proto udp
remote YOUR.RASPBERRYPI.IPADRESS 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
cert mahe.crt
key mahe.key
tls-auth ta.key 1
comp-lzo
verb 3</pre>
<p>Now you can copy the mahe folder to you laptop and for connection run from teh mahe folder. It you make new certs and called them user you must update this hoe to and config to use the correct certs.</p>
<pre>sudo openvpn --config client.conf</pre>
<p>&nbsp;</p>
<p>Make shoure you have udp port 1194 open in you firewall to your raspberry pi.</p>
<p>&nbsp;</p>
<p>When you see this line in the openvpn client you are connected.</p>
<pre>Initialization Sequence Completed</pre>
<p>And now you are routing all you traffic trow the Raspberry Pi</p>
<p>Go toÂ <a href="http://ip-lookup.net/">http://ip-lookup.net/</a>Â and se what public ip you are using.</p>
<p>&nbsp;</p>
