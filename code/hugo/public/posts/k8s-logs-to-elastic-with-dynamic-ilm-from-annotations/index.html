<!DOCTYPE html>
<html lang="en-us">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> K8s Logs to Elastic with Dynamic ILM from annotations | Life and Shell</title>
  <link rel = 'canonical' href = 'https://lifeandshell.com/posts/k8s-logs-to-elastic-with-dynamic-ilm-from-annotations/'>
  <meta name="description" content="  Mattias Hemmingsson: Welcome to my private site collecting blog post, Git updates and podcast episodes">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">



 <script async src="https://www.googletagmanager.com/gtag/js?id=G-3SYH00HY9X"></script>
 <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'G-3SYH00HY9X');
 </script>


  <meta property="og:url" content="https://lifeandshell.com/posts/k8s-logs-to-elastic-with-dynamic-ilm-from-annotations/">
  <meta property="og:site_name" content="Life and Shell">
  <meta property="og:title" content="K8s Logs to Elastic with Dynamic ILM from annotations">
  <meta property="og:description" content="#fluentd #fluent-bit #kubernetes #elasticsearch #ILM #logpain The time a spent fixing logs problems … From cleaning out logs that eats disk setting up log-rotate and now Elasticsearch ….. I want a easy log system that setups a Elasticsearch ILM with different life time on the logs depending on a annotation that I set on the pod.
If no annotations well then I want the logs for 30 days. And then a can set different annotations and store logs for 90 days, send to s3 ore what ever comes up.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-02-18T23:34:48+00:00">
    <meta property="article:modified_time" content="2021-02-18T23:34:48+00:00">
    <meta property="article:tag" content="Linux">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="K8s Logs to Elastic with Dynamic ILM from annotations">
  <meta name="twitter:description" content="#fluentd #fluent-bit #kubernetes #elasticsearch #ILM #logpain The time a spent fixing logs problems … From cleaning out logs that eats disk setting up log-rotate and now Elasticsearch ….. I want a easy log system that setups a Elasticsearch ILM with different life time on the logs depending on a annotation that I set on the pod.
If no annotations well then I want the logs for 30 days. And then a can set different annotations and store logs for 90 days, send to s3 ore what ever comes up.">

  
  
    
  
  
  <link rel="stylesheet" href="https://lifeandshell.com/css/styles.c05d68261bf086a9d7713c4f8a6215a3601608e267a816a7ee58f139b3d1aae51222aae2081c8e0c6bd35e1334773b7a16283022f31f92afd93bb37e5e822e66.css" integrity="sha512-wF1oJhvwhqnXcTxPimIVo2AWCOJnqBan7ljxObPRquUSIqriCByODGvTXhM0dzt6FigwIvMfkq/ZO7N&#43;XoIuZg=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://lifeandshell.com/images/favicon.ico" />

  
  
  

</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts/">Writings</a></li>
         
        <li><a href="/tags/">Tags</a></li>
         
        <li><a href="/git/">Git</a></li>
         
        <li><a href="/podcast/">Podcast</a></li>
         
        <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://lifeandshell.com/posts/gitlab-runners-in-k8s-helm-working-dockerindocker/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://lifeandshell.com/posts/boundery-on-kubernetes-with-keycloak/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&text=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&title=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&is_video=false&description=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations&body=Check out this article: https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&title=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&title=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&name=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations&description=%23fluentd%20%23fluent-bit%20%23kubernetes%20%23elasticsearch%20%23ILM%20%23logpain%20The%20time%20a%20spent%20fixing%20logs%20problems%20%26%238230%3b%20From%20cleaning%20out%20logs%20that%20eats%20disk%20setting%20up%20log-rotate%20and%20now%20Elasticsearch%20%26%238230%3b..%20I%20want%20a%20easy%20log%20system%20that%20setups%20a%20Elasticsearch%20ILM%20with%20different%20life%20time%20on%20the%20logs%20depending%20on%20a%20annotation%20that%20I%20set%20on%20the%20pod.%0aIf%20no%20annotations%20well%20then%20I%20want%20the%20logs%20for%2030%20days.%20And%20then%20a%20can%20set%20different%20annotations%20and%20store%20logs%20for%2090%20days%2c%20send%20to%20s3%20ore%20what%20ever%20comes%20up." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&t=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        K8s Logs to Elastic with Dynamic ILM from annotations
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2021-02-18 23:34:48 &#43;0000 UTC" itemprop="datePublished">2021-02-18</time>
          
        </div>
        
        
        <div class="article-read-time">
          <i class="far fa-clock"></i>
          
          6 minute read
        </div>
        
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/linux">Linux</a>
            
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/linux" rel="tag">Linux</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      
<p>#fluentd #fluent-bit #kubernetes #elasticsearch #ILM #logpain </p>



<p>The time a spent fixing logs problems &#8230; From cleaning out logs that eats disk setting up log-rotate and now Elasticsearch &#8230;.. <br><br>I want a easy log system that setups a Elasticsearch ILM with different life time on the logs depending on a annotation that I set on the pod.<br>If no annotations well then I want the logs for 30 days. And then a can set different annotations and store logs for 90 days, send to s3 ore what ever comes up.(splunk? redshift? kafka ?)<br><br>Fleunt-bit (read logs from pod) &#8211;(send to fluentd)&#8211;>fluentd(parses logs and send to diffrent output. And add Elasticsearch ILM) &#8212;> Elasticsearch</p>



<h2 class="wp-block-heading">Getting logs from the pod fluentd-bit</h2>



<p><br>So first things first lets get the logs from our pods in k8s. I use fluent-bit to collect my logs and a simple config.<br><br>Here is my two config that I use this will read the logs and send it to fluentd.<br>I dont do any parsing of logs here when fluent-bit runs as a demonset I cant scale it. But my fluentd runs as a deployment and that I can scale.<br>(If you want it really good then add a que here like rabbit but it over this post)</p>



<div class="wp-block-group"><div class="wp-block-group__inner-container is-layout-flow wp-block-group-is-layout-flow">
<p></p>



<pre class="wp-block-code"><code>apiVersion: v1
kind: ConfigMap
metadata:
name: fluentbit-config
labels:
app.kubernetes.io/name: fluentbit
data:
fluent-bit.conf: |
&#91;SERVICE]
Parsers_File /fluent-bit/parsers/parsers.conf
Daemon Off
Log_Level info

&#91;INPUT]
    Name              tail
    Tag               kube.*
    Path              /var/log/containers/*.log
    DB                /var/lib/fluent-bit/flb_kube.db
    Parser            docker
    Docker_Mode       On
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   Off
    Refresh_Interval  10

&#91;FILTER]
    Name                kubernetes
    Match               kube.*
    Kube_URL            https://kubernetes.default.svc.cluster.local:443
    Merge_Log           On
    Merge_Log_Key       data
    K8S-Logging.Parser  On
    K8S-Logging.Exclude On

&#91;OUTPUT]
    Name  forward
    Match * 
    Host  fluentd.events.svc
    Port  24224</code></pre>
</div></div>



<p></p>



<pre class="wp-block-code"><code>apiVersion: v1
kind: ConfigMap
metadata:
name: parsers-conf
labels:
app.kubernetes.io/name: fluentbit
data:
parsers.conf: |
&#91;PARSER]
Name apache
Format regex
Regex ^(?&#91;^ ]) &#91;^ ] (?&#91;^ ]) &#91;(?&#91;^]])] "(?\S+)(?: +(?&#91;^\"]?)(?: +\S)?)?" (?&#91;^ ]) (?&#91;^ ])(?: "(?&#91;^\"])" "(?&#91;^\"])")?$
Time_Key time
Time_Format %d/%b/%Y:%H:%M:%S %z

    &#91;PARSER]
        Name   apache2
        Format regex
        Regex  ^(?&lt;host>&#91;^ ]*) &#91;^ ]* (?&lt;user>&#91;^ ]*) \&#91;(?&lt;time>&#91;^\]]*)\] "(?&lt;method>\S+)(?: +(?&lt;path>&#91;^ ]*) +\S*)?" (?&lt;code>&#91;^ ]*) (?&lt;size>&#91;^ ]*)(?: "(?&lt;referer>&#91;^\"]*)" "(?&lt;agent>.*)")?$
        Time_Key time
        Time_Format %d/%b/%Y:%H:%M:%S %z

    &#91;PARSER]
        Name   apache_error
        Format regex
        Regex  ^\&#91;&#91;^ ]* (?&lt;time>&#91;^\]]*)\] \&#91;(?&lt;level>&#91;^\]]*)\](?: \&#91;pid (?&lt;pid>&#91;^\]]*)\])?( \&#91;client (?&lt;client>&#91;^\]]*)\])? (?&lt;message>.*)$

    &#91;PARSER]
        Name   nginx
        Format regex
        Regex ^(?&lt;remote>&#91;^ ]*) (?&lt;host>&#91;^ ]*) (?&lt;user>&#91;^ ]*) \&#91;(?&lt;time>&#91;^\]]*)\] "(?&lt;method>\S+)(?: +(?&lt;path>&#91;^\"]*?)(?: +\S*)?)?" (?&lt;code>&#91;^ ]*) (?&lt;size>&#91;^ ]*)(?: "(?&lt;referer>&#91;^\"]*)" "(?&lt;agent>&#91;^\"]*)")
        Time_Key time
        Time_Format %d/%b/%Y:%H:%M:%S %z

    &#91;PARSER]
        # https://rubular.com/r/IhIbCAIs7ImOkc
        Name        k8s-nginx-ingress
        Format      regex
        Regex       ^(?&lt;host>&#91;^ ]*) - (?&lt;user>&#91;^ ]*) \&#91;(?&lt;time>&#91;^\]]*)\] "(?&lt;method>\S+)(?: +(?&lt;path>&#91;^\"]*?)(?: +\S*)?)?" (?&lt;code>&#91;^ ]*) (?&lt;size>&#91;^ ]*) "(?&lt;referer>&#91;^\"]*)" "(?&lt;agent>&#91;^\"]*)" (?&lt;request_length>&#91;^ ]*) (?&lt;request_time>&#91;^ ]*) \&#91;(?&lt;proxy_upstream_name>&#91;^ ]*)\] (\&#91;(?&lt;proxy_alternative_upstream_name>&#91;^ ]*)\] )?(?&lt;upstream_addr>&#91;^ ]*) (?&lt;upstream_response_length>&#91;^ ]*) (?&lt;upstream_response_time>&#91;^ ]*) (?&lt;upstream_status>&#91;^ ]*) (?&lt;reg_id>&#91;^ ]*).*$
        Time_Key    time
        Time_Format %d/%b/%Y:%H:%M:%S %z

    &#91;PARSER]
        Name   json
        Format json
        Time_Key time
        Time_Format %d/%b/%Y:%H:%M:%S %z

    &#91;PARSER]
        Name         docker
        Format       json
        Time_Key     time
        Time_Format  %Y-%m-%dT%H:%M:%S.%L
        Time_Keep    On
        # --
        # Since Fluent Bit v1.2, if you are parsing Docker logs and using
        # the Kubernetes filter, it's not longer required to decode the
        # 'log' key.
        #
        # Command      |  Decoder | Field | Optional Action
        # =============|==================|=================
        #Decode_Field_As    json     log

    &#91;PARSER]
        Name        docker-daemon
        Format      regex
        Regex       time="(?&lt;time>&#91;^ ]*)" level=(?&lt;level>&#91;^ ]*) msg="(?&lt;msg>&#91;^ ].*)"
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep   On

    &#91;PARSER]
        Name        syslog-rfc5424
        Format      regex
        Regex       ^\&lt;(?&lt;pri>&#91;0-9]{1,5})\>1 (?&lt;time>&#91;^ ]+) (?&lt;host>&#91;^ ]+) (?&lt;ident>&#91;^ ]+) (?&lt;pid>&#91;-0-9]+) (?&lt;msgid>&#91;^ ]+) (?&lt;extradata>(\&#91;(.*)\]|-)) (?&lt;message>.+)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z
        Time_Keep   On

    &#91;PARSER]
        Name        syslog-rfc3164-local
        Format      regex
        Regex       ^\&lt;(?&lt;pri>&#91;0-9]+)\>(?&lt;time>&#91;^ ]* {1,2}&#91;^ ]* &#91;^ ]*) (?&lt;ident>&#91;a-zA-Z0-9_\/\.\-]*)(?:\&#91;(?&lt;pid>&#91;0-9]+)\])?(?:&#91;^\:]*\:)? *(?&lt;message>.*)$
        Time_Key    time
        Time_Format %b %d %H:%M:%S
        Time_Keep   On

    &#91;PARSER]
        Name        syslog-rfc3164
        Format      regex
        Regex       /^\&lt;(?&lt;pri>&#91;0-9]+)\>(?&lt;time>&#91;^ ]* {1,2}&#91;^ ]* &#91;^ ]*) (?&lt;host>&#91;^ ]*) (?&lt;ident>&#91;a-zA-Z0-9_\/\.\-]*)(?:\&#91;(?&lt;pid>&#91;0-9]+)\])?(?:&#91;^\:]*\:)? *(?&lt;message>.*)$/
        Time_Key    time
        Time_Format %b %d %H:%M:%S
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep   On

    &#91;PARSER]
        Name    mongodb
        Format  regex
        Regex   ^(?&lt;time>&#91;^ ]*)\s+(?&lt;severity>\w)\s+(?&lt;component>&#91;^ ]+)\s+\&#91;(?&lt;context>&#91;^\]]+)]\s+(?&lt;message>.*?) *(?&lt;ms>(\d+))?(:?ms)?$
        Time_Format %Y-%m-%dT%H:%M:%S.%L
        Time_Keep   On
        Time_Key time

    &#91;PARSER]
        # https://rubular.com/r/3fVxCrE5iFiZim
        Name    envoy
        Format  regex
        Regex ^\&#91;(?&lt;start_time>&#91;^\]]*)\] "(?&lt;method>\S+)(?: +(?&lt;path>&#91;^\"]*?)(?: +\S*)?)? (?&lt;protocol>\S+)" (?&lt;code>&#91;^ ]*) (?&lt;response_flags>&#91;^ ]*) (?&lt;bytes_received>&#91;^ ]*) (?&lt;bytes_sent>&#91;^ ]*) (?&lt;duration>&#91;^ ]*) (?&lt;x_envoy_upstream_service_time>&#91;^ ]*) "(?&lt;x_forwarded_for>&#91;^ ]*)" "(?&lt;user_agent>&#91;^\"]*)" "(?&lt;request_id>&#91;^\"]*)" "(?&lt;authority>&#91;^ ]*)" "(?&lt;upstream_host>&#91;^ ]*)"  
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z
        Time_Keep   On
        Time_Key start_time

    &#91;PARSER]
        # http://rubular.com/r/tjUt3Awgg4
        Name cri
        Format regex
        Regex ^(?&lt;time>&#91;^ ]+) (?&lt;stream>stdout|stderr) (?&lt;logtag>&#91;^ ]*) (?&lt;message>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

    &#91;PARSER]
        Name    kube-custom
        Format  regex
        Regex   (?&lt;tag>&#91;^.]+)?\.?(?&lt;pod_name>&#91;a-z0-9](?:&#91;-a-z0-9]*&#91;a-z0-9])?(?:\.&#91;a-z0-9](&#91;-a-z0-9]*&#91;a-z0-9])?)*)_(?&lt;namespace_name>&#91;^_]+)_(?&lt;container_name>.+)-(?&lt;docker_id>&#91;a-z0-9]{64})\.log$</code></pre>



<p><br></p>



<h2 class="wp-block-heading">Time for fluentd to do its thing and let stop wasting time fixing logs</h2>



<p>First we need to build our fluentd so we have the gems we need. Here is the dockerfile a use.</p>



<pre class="wp-block-code"><code>FROM fluent/fluentd:v1.12-debian-1<br>Use root account to use apt<br>USER root<br>below RUN includes plugin as examples elasticsearch is not required<br>you may customize including plugins as you wish<br>RUN buildDeps="sudo make gcc g++ libc-dev" \<br>&amp;&amp; apt-get update \<br>&amp;&amp; apt-get install -y --no-install-recommends $buildDeps \<br>&amp;&amp; sudo gem install fluent-plugin-elasticsearch \<br>&amp;&amp; sudo gem install fluent-plugin-multi-format-parser \<br>&amp;&amp; sudo gem install fluent-plugin-grok-parser \<br>&amp;&amp; sudo gem install fluent-plugin-rewrite-tag-filter \<br>&amp;&amp; sudo gem install fluent-plugin-prometheus \<br>&amp;&amp; sudo gem install fluent-plugin-dedot_filter \<br>&amp;&amp; sudo gem install elasticsearch-xpack \<br>&amp;&amp; sudo gem sources --clear-all \<br>&amp;&amp; SUDO_FORCE_REMOVE=yes \<br>apt-get purge -y --auto-remove \<br>-o APT::AutoRemove::RecommendsImportant=false \<br>$buildDeps \<br>&amp;&amp; rm -rf /var/lib/apt/lists/* \<br>&amp;&amp; rm -rf /tmp/* /var/tmp/* /usr/lib/ruby/gems/<em>/cache/</em>.gem<br>USER fluent</code></pre>



<p>So now we have a woring fluent docker image that you can run and here is the fluentd-config that make it all happend.<br><br></p>



<pre class="wp-block-code"><code>apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: events
data:
  fluent.conf: |
      # Forwarded from fluentd
      &lt;system>
      &lt;log>
         format json
         time_format %Y-%m-%d
         level error
      &lt;/log>
      &lt;/system>
    
    
      &lt;source>
        @type forward
        port 24224
        bind 0.0.0.0
        tag kube
      &lt;/source>

      &lt;filter kube.**>
        @type             dedot
        de_dot            true
        de_dot_separator  _
        de_dot_nested     true
      &lt;/filter>

      #Setup so that logs endup in there correct index based on namespace and container
      #
      # 
      &lt;filter kube.**>
        @type record_transformer
        enable_ruby
        &lt;record>
          index_name ${record&#91;'kubernetes']&#91;'namespace_name'] or 'service' }.${record&#91;'kubernetes']&#91;'container_name'] or 'app'}
        &lt;/record>
        &lt;record>
        index_name ${record&#91;'kubernetes']&#91;'namespace_name'] or 'service' }.${record&#91;'kubernetes']&#91;'container_name'] or 'app'}
        &lt;/record>
      &lt;/filter>

      # How ling should e save the index 
      # If the deployemt has a tag annotions kubernetes.annotations.logtime we can set how long we want to save a log 
      &lt;filter kube.**>
        @type record_transformer
        enable_ruby
        &lt;record>
          logtime ${record&#91;'kubernetes']&#91;'annotations']&#91;'logtime'] or 'default' }
        &lt;/record>
      &lt;/filter>


      &lt;filter fluentd.**>
        @type record_transformer
        enable_ruby
        &lt;record>
          index_name kube.events.fluentd
        &lt;/record>
        &lt;record>
          logid kube.events.fluentd
        &lt;/record>
      &lt;/filter>

      &lt;filter kube.**>
        @type parser
        key_name log
        reserve_data true
        reserve_time true
        &lt;parse>
          @type multi_format
          &lt;pattern>
            format json
            time_key timestamp
          &lt;/pattern>
          &lt;pattern>
            format syslog
          &lt;/pattern>
          &lt;pattern>
            format nginx
          &lt;/pattern>
          &lt;pattern>
            format apache
          &lt;/pattern>
          &lt;pattern>
            format none
          &lt;/pattern>
        &lt;/parse>
      &lt;/filter>


      &lt;filter kube.**>
        @type record_transformer
        remove_keys message
      &lt;/filter>


      #Based in the ${record&#91;'kubernetes']&#91;'annotations']&#91;'logtime'] we set the tag.
      #
      # Then we can use diffrent output with diffrent policies
      #
      &lt;match kube.**>
        @type rewrite_tag_filter
        &lt;rule>
            key logtime
            pattern ^(.*)
            tag $1.${tag}
        &lt;/rule>
        # more rules
      &lt;/match>



      # Send logs to elasticsearch
        &lt;match default.kube.**>
          @id elasticsearch
          @type elasticsearch
          @log_level info
          include_tag_key true
          host "#{ENV&#91;'ELASTICSEARCH_URL']}"
          port 9200
          default_elasticsearch_version 7
          verify_es_version_at_startup true
          suppress_type_name true
          logstash_format true
          logstash_prefix kube.${index_name}
          #application_name ${index_name}
          logstash_prefix_separator .
          enable_ilm true
          ilm_policy_id fluentd-logs
          ilm_policy {"policy":{"phases":{"hot":{"min_age":"0ms","actions":{"rollover":{"max_age":"3d","max_size":"20gb"},"set_priority":{"priority":100}}},"warm":{"actions":{"allocate":{"include":{},"exclude":{},"require":{"data":"warm"}},"set_priority":{"priority":50}}},"delete":{"min_age":"90d","actions":{"delete":{}}}}}}
          ilm_policy_overwrite false
          log_es_400_reason true
          # Disabled until https://github.com/uken/fluent-plugin-elasticsearch/issues/798 is fixed
          # templates { "logs": "//cdn.lifeandshell.com/etc/fluent/config.d/logs-es-template.json", "formative-logs": "//cdn.lifeandshell.com/etc/fluent/config.d/formative-es-template.json", "webclient-logs": "//cdn.lifeandshell.com/etc/fluent/config.d/webclient-es-template.json" }
          template_overwrite true
          template_name logs
          template_file "//cdn.lifeandshell.com/fluentd/index/elastic.json"
         &lt;buffer tag,time,index_name,logtime>
            @type memory
            timekey 60
            total_limit_size 128M
            chunk_limit_size 32M
            overflow_action block
            chunk_full_threshold 0.9
            compress gzip       # text,gzip
            flush_mode interval
            flush_interval 10s
            flush_at_shutdown true
            flush_thread_count 4
          &lt;/buffer>

       &lt;/match>


      # Send logs to elasticsearch
        &lt;match 90days.kube.**>
          @id elasticsearch
          @type elasticsearch
          @log_level info
          include_tag_key true
          host "#{ENV&#91;'ELASTICSEARCH_URL']}"
          port 9200
          default_elasticsearch_version 7
          verify_es_version_at_startup true
          suppress_type_name true
          logstash_format true
          logstash_prefix kube.${index_name}
          #application_name ${index_name}
          logstash_prefix_separator .
          enable_ilm true
          ilm_policy_id fluentd-logs-90days
          ilm_policy {"policy":{"phases":{"hot":{"min_age":"0ms","actions":{"rollover":{"max_age":"3d","max_size":"20gb"},"set_priority":{"priority":100}}},"warm":{"actions":{"allocate":{"include":{},"exclude":{},"require":{"data":"warm"}},"set_priority":{"priority":50}}},"delete":{"min_age":"90d","actions":{"delete":{}}}}}}
          ilm_policy_overwrite false
          log_es_400_reason true
          # Disabled until https://github.com/uken/fluent-plugin-elasticsearch/issues/798 is fixed
          # templates { "logs": "//cdn.lifeandshell.com/etc/fluent/config.d/logs-es-template.json", "formative-logs": "//cdn.lifeandshell.com/etc/fluent/config.d/formative-es-template.json", "webclient-logs": "//cdn.lifeandshell.com/etc/fluent/config.d/webclient-es-template.json" }
          template_overwrite true
          template_name logs
          template_file "//cdn.lifeandshell.com/fluentd/index/elastic.json"
         &lt;buffer tag,time,index_name,logtime>
            @type memory
            timekey 60
            total_limit_size 128M
            chunk_limit_size 32M
            overflow_action block
            chunk_full_threshold 0.9
            compress gzip       # text,gzip
            flush_mode interval
            flush_interval 10s
            flush_at_shutdown true
            flush_thread_count 4
          &lt;/buffer>

       &lt;/match>


      # expose metrics in prometheus format
      &lt;source>
        @type prometheus
        bind 0.0.0.0
        port 24231
        metrics_path /metrics
      &lt;/source>
      &lt;source>
        @type prometheus_output_monitor
        interval 10
        &lt;labels>
          fluentd shipper
        &lt;/labels>
      &lt;/source></code></pre>



<p>Now you can look for index in elastic starting with <br><br><strong>kube.namespace.podname</strong></p>



<p>And you can also look for index ILM and patter for the index.<br></p>



<h2 class="wp-block-heading">Setup new endpoints easy with annotations </h2>



<p>And if you want to change the log standard for the logs you can in your deploy a the annotations</p>



<p> </p>



<pre class="wp-block-code"><code>  annotations:
    logtime: 90days</code></pre>



<p>You can then add new values to the annotaions and send the logs to diffrent buckets</p>



<pre class="wp-block-code"><code>&lt;match 90days.kube.**></code></pre>



<p></p>



<p>You can also do </p>



<pre class="wp-block-code"><code>annotations:
    logtime: default

annotations:
    logtime: default.s3

annotations:
    logtime: default.90days
</code></pre>



<p>And then have matching rules </p>



<pre class="wp-block-code"><code>&lt;match default.**>
Take all logs

&lt;match default.s3.**>
Take only the s3

&lt;match default.90days.**>
Take on the 90days </code></pre>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts/">Writings</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/git/">Git</a></li>
         
          <li><a href="/podcast/">Podcast</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&text=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&title=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&is_video=false&description=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations&body=Check out this article: https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&title=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&title=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&name=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations&description=%23fluentd%20%23fluent-bit%20%23kubernetes%20%23elasticsearch%20%23ILM%20%23logpain%20The%20time%20a%20spent%20fixing%20logs%20problems%20%26%238230%3b%20From%20cleaning%20out%20logs%20that%20eats%20disk%20setting%20up%20log-rotate%20and%20now%20Elasticsearch%20%26%238230%3b..%20I%20want%20a%20easy%20log%20system%20that%20setups%20a%20Elasticsearch%20ILM%20with%20different%20life%20time%20on%20the%20logs%20depending%20on%20a%20annotation%20that%20I%20set%20on%20the%20pod.%0aIf%20no%20annotations%20well%20then%20I%20want%20the%20logs%20for%2030%20days.%20And%20then%20a%20can%20set%20different%20annotations%20and%20store%20logs%20for%2090%20days%2c%20send%20to%20s3%20ore%20what%20ever%20comes%20up." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2flifeandshell.com%2fposts%2fk8s-logs-to-elastic-with-dynamic-ilm-from-annotations%2f&t=K8s%20Logs%20to%20Elastic%20with%20Dynamic%20ILM%20from%20annotations" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2026  Mattias Hemmingssion <a href="mailto:mattias@lifeandshell.com">mattias@lifeandshell.com</a> 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts/">Writings</a></li>
         
        <li><a href="/tags/">Tags</a></li>
         
        <li><a href="/git/">Git</a></li>
         
        <li><a href="/podcast/">Podcast</a></li>
         
        <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
