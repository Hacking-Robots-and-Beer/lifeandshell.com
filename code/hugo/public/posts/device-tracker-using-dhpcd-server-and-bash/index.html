<!DOCTYPE html>
<html lang="en-us">
<head>
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-brands-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-regular-400.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/font-awesome/webfonts/fa-solid-900.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="preload" href="/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Device Tracker using Dhpcd server and bash | Life and Shell</title>
  <link rel = 'canonical' href = 'https://lifeandshell.com/posts/device-tracker-using-dhpcd-server-and-bash/'>
  <meta name="description" content="  Mattias Hemmingsson: Welcome to my private site collecting blog post, Git updates and podcast episodes">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">



 <script async src="https://www.googletagmanager.com/gtag/js?id=G-3SYH00HY9X"></script>
 <script>
   window.dataLayer = window.dataLayer || [];
   function gtag(){dataLayer.push(arguments);}
   gtag('js', new Date());
   gtag('config', 'G-3SYH00HY9X');
 </script>


  <meta property="og:url" content="https://lifeandshell.com/posts/device-tracker-using-dhpcd-server-and-bash/">
  <meta property="og:site_name" content="Life and Shell">
  <meta property="og:title" content="Device Tracker using Dhpcd server and bash">
  <meta property="og:description" content="I have used Home Assistance for some time. And have always used the device tracker to set different actions based if I’m home or not.
But when my pfsense died and a install a clean Linux box as my fw and DHCP server I lost all my tracking for devices.
But I did found out that the dhcpd server can run a command every time it hands out a dhcpds leese.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-12-21T14:07:01+00:00">
    <meta property="article:modified_time" content="2022-12-21T14:07:01+00:00">
    <meta property="article:tag" content="Code">
    <meta property="article:tag" content="Life">
    <meta property="article:tag" content="Linux">

  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Device Tracker using Dhpcd server and bash">
  <meta name="twitter:description" content="I have used Home Assistance for some time. And have always used the device tracker to set different actions based if I’m home or not.
But when my pfsense died and a install a clean Linux box as my fw and DHCP server I lost all my tracking for devices.
But I did found out that the dhcpd server can run a command every time it hands out a dhcpds leese.">

  
  
    
  
  
  <link rel="stylesheet" href="https://lifeandshell.com/css/styles.c05d68261bf086a9d7713c4f8a6215a3601608e267a816a7ee58f139b3d1aae51222aae2081c8e0c6bd35e1334773b7a16283022f31f92afd93bb37e5e822e66.css" integrity="sha512-wF1oJhvwhqnXcTxPimIVo2AWCOJnqBan7ljxObPRquUSIqriCByODGvTXhM0dzt6FigwIvMfkq/ZO7N&#43;XoIuZg=="> 

  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://lifeandshell.com/images/favicon.ico" />

  
  
  

</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;" aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts/">Writings</a></li>
         
        <li><a href="/tags/">Tags</a></li>
         
        <li><a href="/git/">Git</a></li>
         
        <li><a href="/podcast/">Podcast</a></li>
         
        <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://lifeandshell.com/posts/migrate-elasticsearch-helm-to-elasticsearch-operator/" aria-label="Previous">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://lifeandshell.com/posts/k3s-cluster-on-setup-master-and-node/" aria-label="Next">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#" aria-label="Share">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f" aria-label="Facebook">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&text=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="Twitter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&title=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="Linkedin">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&is_video=false&description=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="Pinterest">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash&body=Check out this article: https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f" aria-label="Email">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&title=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="Pocket">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&title=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="reddit">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&name=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash&description=I%20have%20used%20Home%20Assistance%20for%20some%20time.%20And%20have%20always%20used%20the%20device%20tracker%20to%20set%20different%20actions%20based%20if%20I%26%238217%3bm%20home%20or%20not.%0aBut%20when%20my%20pfsense%20died%20and%20a%20install%20a%20clean%20Linux%20box%20as%20my%20fw%20and%20DHCP%20server%20I%20lost%20all%20my%20tracking%20for%20devices.%0aBut%20I%20did%20found%20out%20that%20the%20dhcpd%20server%20can%20run%20a%20command%20every%20time%20it%20hands%20out%20a%20dhcpds%20leese." aria-label="Tumblr">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&t=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="Hacker News">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    
    <div id="toc">
      
    </div>
    
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Device Tracker using Dhpcd server and bash
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2022-12-21 14:07:01 &#43;0000 UTC" itemprop="datePublished">2022-12-21</time>
          
        </div>
        
        
        <div class="article-read-time">
          <i class="far fa-clock"></i>
          
          3 minute read
        </div>
        
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/code">Code</a>
            
             ,  
            <a class="category-link" href="/categories/life">Life</a>
            
             ,  
            <a class="category-link" href="/categories/linux">Linux</a>
            
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/code" rel="tag">Code</a>
            
             ,  
            <a class="tag-link" href="/tags/life" rel="tag">Life</a>
            
             ,  
            <a class="tag-link" href="/tags/linux" rel="tag">Linux</a>
            
        </div>
        
      </div>
    </header>

  
    
    <div class="content" itemprop="articleBody">
      
<p>I have used Home Assistance for some time. And have always used the device tracker to set different actions based if I&#8217;m home or not.<br>But when my pfsense died and a install a clean Linux box as my fw and DHCP server I lost all my tracking for devices.</p>



<p>But I did found out that the dhcpd server can run a command every time it hands out a dhcpds leese. And HA has a great API that you can use !<br><br>So with this a setup some small bash script in not more then 10 lines that connects and add my devices to HA<br></p>



<h2 class="wp-block-heading"><br>1. Set mac to state Home !</h2>



<p>Let&#8217;s get our dhpcd server to run a bash script. The script gets the mac and sets the state in HA for the mac to home. It also saves the mac in a file in a folder that we will use later</p>



<p><code>on commit {<br></code>set ClientIP = binary-to-ascii(10, 8, &#8220;.&#8221;, leased-address);<br>set ClientMac = binary-to-ascii(16, 8, &#8220;:&#8221;, substring(hardware, 1, 6));<br>set ClientHost = pick-first-value (option fqdn.hostname, option host-name, &#8220;&#8221;);<br>log(concat(&#8220;Commit: IP: &#8220;, ClientIP, &#8221; Mac: &#8220;, ClientMac));<br>execute(&#8220;/etc/dhcp/ha-precense.sh&#8221;, &#8220;commit&#8221;, ClientIP, ClientMac, ClientHost);</p>



<p><code>}</code></p>



<p><br>Add this into your dhcpd config. It is called the script ha-precense.se, and below is that script.</p>



<pre class="wp-block-code"><code>#!/bin/bash
#
#
# script that add devices to ha 
NAME=$1
IP=$2
MAC=$3
HOSTNAME=$4
MACNAME=$(echo "$MAC" | sed "s/:/_/g")
TOKEN=
echo "Adding the foollowing name to Home Assitance $NAME $IP $MAC $HOSTNAME"
if &#91; -z "$var" ]
then
      echo "Adding the foollowing name to Home Assitance $NAME $IP $MAC $HOSTNAME" > /var/log/ha-devices/$MAC
      curl -X POST -H "Authorization: Bearer $TOKEN" \
         -H "Content-Type: application/json" \
         -d '{"state": "home" }' \
        http:&#47;&#47;localhost:8123/api/states/device_tracker.$MACNAME
else
      echo "Adding the foollowing name to Home Assitance $NAME $IP $MAC $HOSTNAME" > /var/log/ha-devices/$HOSTNAME
      curl -X POST -H "Authorization: Bearer $TOKEN" \
         -H "Content-Type: application/json" \
         -d '{"state": "home" }' \
        http://localhost:8123/api/states/device_tracker.$HOSTNAME

fi
</code></pre>



<p>Add your token that you will get from home assistance.<br>And change the localhost, so it points to your home assistance </p>



<h2 class="wp-block-heading">2. Set the to not_home</h2>



<p>Now we have a lot of mac that are in state Home bu for our device tracker to work we also need to have them in state not_home.<br>For that, we use the files we created before. We look at the files that are more then 1h old. If there are more then set the state for that mac to not_home. And remove the file.</p>



<pre class="wp-block-code"><code>#!/bin/bash
#
# Detect old leease and set them as nothome in HA
#
DEVICES=$(find /var/log/ha-devices/ -type f -mmin +60)
TOKEN=

for i in $DEVICES;
 do
    MAC=$(echo $i | awk -F/ '{print $NF}')
    MACNAME=$(echo "$MAC" | sed "s/:/_/g")
    echo "Setting $MAC to not home"
    curl -X POST -H "Authorization: Bearer $TOKEN" \
  		-H "Content-Type: application/json" \
  		-d '{"state": "not_home" }' \
  			http:&#47;&#47;localhost:8123/api/states/device_tracker.$MACNAME
    rm $i


done
</code></pre>



<p>Same here as before add you own token and change the localhost address to match your setup.<br>I have setup a crontab to run this every 5 min.<br><br></p>



<h2 class="wp-block-heading">More fix</h2>



<p>So the tracker now should be fast when a device arrives to the network and get a IP. Then the state in HA will change at once.<br>But setting the state to away may be slower  depending on some things that you can configure as you want<br>&#8211; dhcpd leease time is how often a client will request for a new IP. </p>



<p>&#8211; In the remove script when you find files older then. its good to match this with the leease time </p>



<p>&#8211; How often you run the remove script in crontab. </p>



<p>For me don&#8217;t care if it quick so I have those set to 60min and clean every 5 min for now.<br></p>

    </div>
  </article>

  
  






  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts/">Writings</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/git/">Git</a></li>
         
          <li><a href="/podcast/">Podcast</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    
    <div id="toc-footer" style="display: none">
      
    </div>
    

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f" aria-label="Facebook">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&text=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="Twitter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&title=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="Linkedin">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&is_video=false&description=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="Pinterest">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash&body=Check out this article: https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f" aria-label="Email">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&title=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="Pocket">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&title=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="reddit">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&name=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash&description=I%20have%20used%20Home%20Assistance%20for%20some%20time.%20And%20have%20always%20used%20the%20device%20tracker%20to%20set%20different%20actions%20based%20if%20I%26%238217%3bm%20home%20or%20not.%0aBut%20when%20my%20pfsense%20died%20and%20a%20install%20a%20clean%20Linux%20box%20as%20my%20fw%20and%20DHCP%20server%20I%20lost%20all%20my%20tracking%20for%20devices.%0aBut%20I%20did%20found%20out%20that%20the%20dhcpd%20server%20can%20run%20a%20command%20every%20time%20it%20hands%20out%20a%20dhcpds%20leese." aria-label="Tumblr">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2flifeandshell.com%2fposts%2fdevice-tracker-using-dhpcd-server-and-bash%2f&t=Device%20Tracker%20using%20Dhpcd%20server%20and%20bash" aria-label="Hacker News">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu-toggle" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;" aria-label="Menu">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
        <a id="toc-toggle" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;" aria-label="TOC">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share-toggle" class="icon" href="#" onclick="$('#share-footer').toggle();return false;" aria-label="Share">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" aria-label="Top of Page">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2026  Mattias Hemmingssion <a href="mailto:mattias@lifeandshell.com">mattias@lifeandshell.com</a> 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts/">Writings</a></li>
         
        <li><a href="/tags/">Tags</a></li>
         
        <li><a href="/git/">Git</a></li>
         
        <li><a href="/podcast/">Podcast</a></li>
         
        <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>

<script src=/js/code-copy.js></script>




</html>
